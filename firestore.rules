rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user belongs to the clinic they are accessing.
    // An owner's uid IS the clinicId. Other users would have a mapping in a 'users' collection.
    function isClinicMember(clinicId) {
      return request.auth != null && (request.auth.uid == clinicId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.clinicId == clinicId);
    }

    // A user can read their own user document (which might map them to a clinic).
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // Writes to user documents are disallowed from the client for security.
      allow write: if false;
    }

    match /clinics/{clinicId} {
      // Clinic settings can be read by clinic members. Writes are not allowed from the client.
      allow read: if isClinicMember(clinicId);
      allow write: if false;

      // --- Validation Rules for Sub-collections ---

      // Doctors: Must have a name and specialization.
      match /doctors/{doctorId} {
        allow read, delete: if isClinicMember(clinicId);
        allow create, update: if isClinicMember(clinicId)
                            && request.resource.data.name is string
                            && request.resource.data.name.size() > 1
                            && request.resource.data.specialization is string
                            && request.resource.data.specialization.size() > 1;
      }

      // Patients: Validate fields.
      match /patients/{patientId} {
        allow read, write: if isClinicMember(clinicId)
                          && request.resource.data.name is string
                          && request.resource.data.name.size() > 1
                          && request.resource.data.phone is string
                          && request.resource.data.age is number
                          && request.resource.data.gender in ['Male', 'Female', 'Other'];
      }

      // Waiting List & Pharmacy Queue: General access for clinic members.
      // More specific rules can be added later if needed.
      match /waitingList/{waitingId} {
        allow read, write: if isClinicMember(clinicId);
      }

      match /pharmacyQueue/{prescriptionId} {
        allow read, write: if isClinicMember(clinicId);
      }
    }
  }
}
