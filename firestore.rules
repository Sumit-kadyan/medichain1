
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an authorized member of the clinic
    function isClinicMember(clinicId) {
      // A user is a member if they are authenticated and their UID matches the clinic ID.
      // This is a simple model where the clinic owner's UID is the clinicId.
      return request.auth != null && request.auth.uid == clinicId;
    }

    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Disallow client-side writes to user profiles
    }

    match /clinics/{clinicId} {
      // Clinic settings can be read by members, but not written to from the client.
      allow read: if isClinicMember(clinicId);
      allow write: if false;

      // Rules for sub-collections
      match /doctors/{doctorId} {
        allow read, write: if isClinicMember(clinicId);
      }
      match /patients/{patientId} {
        allow read, write: if isClinicMember(clinicId);
      }
      match /waitingList/{waitId} {
        allow read, write: if isClinicMember(clinicId);
      }

      // Special rule for the pharmacy queue (bills)
      match /pharmacyQueue/{prescriptionId} {
        // Allow anyone to GET a single bill document for public sharing.
        allow get: if true;

        // All other operations (list, create, update, delete) require membership.
        allow list, create, update, delete: if isClinicMember(clinicId);
      }
    }
  }
}
