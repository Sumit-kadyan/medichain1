rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ§© Helper: Determine if the current user belongs to the clinic
    function isClinicMember(clinicId) {
      // true if the user is the clinic owner
      return request.auth != null && (
        request.auth.uid == clinicId ||

        // or the user's profile (/users/{uid}) lists the same clinicId
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.clinicId == clinicId
      );
    }

    // ğŸ¥ Clinics Collection
    match /clinics/{clinicId} {
      // Clinic metadata is readable by members only, not writable from the client
      allow read: if isClinicMember(clinicId);
      allow write: if false;

      // ğŸ‘¨â€âš•ï¸ Doctors sub-collection
      match /doctors/{docId} {
        allow read, write: if isClinicMember(clinicId);
      }

      // ğŸ‘©â€âš•ï¸ Patients sub-collection
      match /patients/{patId} {
        allow read, write: if isClinicMember(clinicId);
      }

      // ğŸ•’ Waiting list sub-collection
      match /waitingList/{wId} {
        allow read, write: if isClinicMember(clinicId);
      }

      // ğŸ’Š Pharmacy Queue (Bills)
      match /pharmacyQueue/{prescId} {
        // Anyone can view a single bill (for QR/public links)
        allow get: if true;

        // Only clinic members can list, create, update, or delete
        allow list, create, update, delete: if isClinicMember(clinicId);
      }
    }

    // ğŸ‘¤ Users Collection
    match /users/{userId} {
      // A user can read their own document
      allow read: if request.auth != null && request.auth.uid == userId;

      // No direct writes from the client to user documents
      allow write: if false;
    }
  }
}